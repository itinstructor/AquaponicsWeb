{% extends "base.html" %}

{% block title %}Photo Gallery{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.12.0/baguetteBox.min.css">

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ðŸ“· Photo Gallery</h2>
        {% if user %}
        <a href="{{ url_for('blog_bp.upload_photo') }}" class="btn btn-primary">
            <i class="bi bi-upload"></i> Upload Photo
        </a>
        {% endif %}
    </div>

    {% if user %}
    <div class="alert alert-info mb-3">
        <i class="bi bi-arrows-move"></i> Drag and drop photos to reorder them.
    </div>
    {% endif %}

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if photos %}
    <div class="row gallery" id="gallery">
        {% for photo in photos %}
        <div class="col-md-4 col-sm-6 mb-4 photo-item" data-id="{{ photo.id }}" {% if user %}draggable="true"{% endif %}>
            <div class="card h-100">
                <a href="{{ url_for('blog_bp.serve_photo', filename=photo.filename) }}" data-caption="{{ photo.caption }}">
                    <img src="{{ url_for('blog_bp.serve_photo', filename=photo.filename) }}" 
                         class="card-img-top img-fluid" 
                         alt="{{ photo.caption }}" 
                         style="width: 100%; height: auto; object-fit: contain;">
                </a>
                <div class="card-body">
                    <p class="card-text">{{ photo.caption or 'No caption' }}</p>
                    {% if photo.description %}
                    <p class="card-text small text">{{ photo.description }}</p>
                    {% endif %}
                    
                </div>
                {% if user %}
                <div class="card-footer">
                    <a href="{{ url_for('blog_bp.edit_photo', photo_id=photo.id) }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                    <form action="{{ url_for('blog_bp.delete_photo', photo_id=photo.id) }}" method="post" class="d-inline" onsubmit="return confirm('Delete this photo?');">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        No photos yet. {% if user %}Be the first to upload one!{% endif %}
    </div>
    {% endif %}
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.12.0/baguetteBox.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
    baguetteBox.run('#gallery');
    
    {% if user %}
    // Enable drag-and-drop reordering for logged-in users
    const gallery = document.getElementById('gallery');
    if (gallery) {
        new Sortable(gallery, {
            animation: 150,
            ghostClass: 'bg-light',
            onEnd: function(evt) {
                const items = gallery.querySelectorAll('.photo-item');
                const order = Array.from(items).map(item => parseInt(item.dataset.id));
                
                fetch('{{ url_for("blog_bp.reorder_photos") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ order: order })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Photos reordered successfully');
                    } else {
                        console.error('Reorder failed:', data.error);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });
    }
    {% endif %}
</script>
{% endblock %}
